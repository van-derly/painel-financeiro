<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finan√ßas">
    <title>Painel Vanderly</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --bg-color: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --accent-color: #007AFF;
            --up-color: #34C759;
            --up-bg: rgba(52, 199, 89, 0.15);
            --down-color: #FF3B30;
            --down-bg: rgba(255, 59, 48, 0.15);
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #000000;
                --card-bg: #1C1C1E;
                --text-primary: #FFFFFF;
                --text-secondary: #98989D;
                --shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0; padding: 0; padding-bottom: 80px; 
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- TELA DE BLOQUEIO --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        .lock-content { text-align: center; width: 100%; max-width: 300px; }
        .lock-input {
            width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px;
            border: 1px solid var(--text-secondary); font-size: 18px; text-align: center;
            background: var(--card-bg); color: var(--text-primary); -webkit-appearance: none;
        }
        .lock-btn {
            background-color: var(--accent-color); color: white; border: none; padding: 15px 40px;
            border-radius: 12px; font-size: 18px; font-weight: 600; width: 100%;
        }
        .hidden { display: none !important; }

        /* --- LAYOUT --- */
        header {
            padding-top: max(20px, env(safe-area-inset-top)); padding-bottom: 15px;
            padding-left: 20px; padding-right: 20px; background: var(--bg-color);
            display: flex; align-items: center; justify-content: space-between;
        }
        
        .header-profile {
            display: flex; align-items: center; gap: 12px;
        }
        .app-icon {
            width: 40px; height: 40px; background: var(--accent-color);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; box-shadow: 0 4px 10px rgba(0,122,255,0.3);
        }
        .user-info h1 { font-size: 22px; font-weight: 800; margin: 0; line-height: 1.1; }
        .user-info p { font-size: 12px; color: var(--text-secondary); margin: 0; text-transform: uppercase; letter-spacing: 0.5px; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 20px; }

        .card {
            background-color: var(--card-bg); border-radius: 18px; padding: 16px;
            box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between;
            min-height: 110px; position: relative; transition: transform 0.2s;
            cursor: pointer;
        }
        .card:active { transform: scale(0.96); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .ticker { font-size: 14px; font-weight: 700; color: var(--text-secondary); }
        .badge { font-size: 11px; font-weight: 700; padding: 4px 6px; border-radius: 6px; }
        .up { color: var(--up-color); background-color: var(--up-bg); }
        .down { color: var(--down-color); background-color: var(--down-bg); }
        
        .price-container { margin-top: 10px; }
        .price { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; word-wrap: break-word; line-height: 1.2; }
        .price-secondary { color: var(--text-secondary); font-size: 0.85em; }
        .name { font-size: 10px; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sparkline { width: 100%; height: 30px; margin-top: 8px; opacity: 0.7; }

        /* Not√≠cias Ticker (Lento) */
        .news-ticker {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: rgba(29, 29, 31, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(255,255,255,0.1); display: flex; align-items: center; overflow: hidden; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; }
        .ticker-move { display: inline-block; animation: ticker 60s linear infinite; } /* 60s = Mais lento */
        .ticker-item { display: inline-block; padding: 0 30px; font-size: 14px; color: white; }
        .ticker-source { font-weight: bold; color: #0A84FF; }
        @keyframes ticker { 0% { transform: translate3d(100%, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- TELA DE DETALHE (MODAL) --- */
        #detail-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); z-index: 5000;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease-in-out;
            padding-top: max(20px, env(safe-area-inset-top));
        }
        #detail-view.active { transform: translateY(0); }
        
        .detail-header {
            padding: 20px; display: flex; align-items: center; justify-content: space-between;
        }
        .close-btn {
            background: rgba(128,128,128,0.2); border: none; width: 32px; height: 32px;
            border-radius: 50%; color: var(--text-primary); font-size: 16px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .detail-info { text-align: center; }
        .detail-price { font-size: 32px; font-weight: 800; margin: 5px 0; }
        .detail-ticker { color: var(--text-secondary); font-weight: 600; text-transform: uppercase; }
        
        .chart-controls {
            display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; padding: 0 20px;
        }
        .period-btn {
            background: var(--card-bg); border: 1px solid rgba(128,128,128,0.2);
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            color: var(--text-primary); transition: all 0.2s;
        }
        .period-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        
        .chart-container {
            flex: 1; padding: 10px; position: relative;
            background: var(--card-bg); border-radius: 24px 24px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); margin-top: 10px;
        }

    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="lock-content">
            <div style="font-size: 40px; margin-bottom: 20px;">üîí</div>
            <h1>Bem-vindo, Vanderly</h1>
            <p class="subtitle">Digite sua senha</p>
            <input type="password" id="user-password" class="lock-input" placeholder="Senha" inputmode="numeric">
            <button onclick="checkPassword()" class="lock-btn">Acessar</button>
            <p id="error-msg" style="color: red; font-size: 12px; margin-top: 10px; display: none;">Senha incorreta</p>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header>
            <div class="header-profile">
                <div class="app-icon"><i class="fa-solid fa-chart-line"></i></div>
                <div class="user-info">
                    <p id="last-update">Atualizando...</p>
                    <h1>Vanderly</h1>
                </div>
            </div>
            <div onclick="fetchData()" style="padding: 10px; cursor: pointer;">
                <i class="fa-solid fa-rotate-right" style="color: var(--accent-color);"></i>
            </div>
        </header>

        <div class="grid" id="cards-container"></div>

        <div class="news-ticker">
            <div class="ticker-wrap">
                <div class="ticker-move" id="news-content"></div>
            </div>
        </div>
    </div>

    <div id="detail-view">
        <div class="detail-header">
            <button class="close-btn" onclick="closeDetail()"><i class="fa-solid fa-xmark"></i></button>
            <div class="detail-info">
                <div class="detail-ticker" id="detail-ticker">PETR4</div>
                <div style="font-size: 12px; opacity: 0.7;" id="detail-name">Petrobras</div>
            </div>
            <div style="width: 32px;"></div> </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <div class="detail-price" id="detail-price">R$ 35,00</div>
            <div id="detail-change" style="font-weight: 600; font-size: 16px;">+1.50%</div>
        </div>

        <div class="chart-controls">
            <button class="period-btn active" onclick="changePeriod('1d')">1D</button>
            <button class="period-btn" onclick="changePeriod('5d')">5D</button>
            <button class="period-btn" onclick="changePeriod('1mo')">1M</button>
            <button class="period-btn" onclick="changePeriod('1y')">1A</button>
        </div>

        <div class="chart-container">
            <canvas id="assetChart"></canvas>
            <div id="chart-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                Carregando...
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const MY_PASSWORD = '3210'; 
        // COLE SEU TOKEN DA BRAPI AQUI:
        let brapiToken = 'ajYyxYZW6sDcxQ6QLk1JPm'; 

        const assets = [
            { id: 'USD', type: 'currency', name: 'D√≥lar Comercial' },
            { id: 'BTC', type: 'crypto', name: 'Bitcoin (Global)' }, 
            { id: 'IBOV', type: 'index', name: 'Ibovespa' },
            { id: 'BBAS3', type: 'stock', name: 'Banco do Brasil' },
            { id: 'BBDC3', type: 'stock', name: 'Bradesco ON' },
            { id: 'JBSS32', type: 'stock', name: 'JBS N.V. (BDR)' }, 
            { id: 'SBSP3', type: 'stock', name: 'Sabesp' },
            { id: 'WEGE3', type: 'stock', name: 'WEG S.A.' }
        ];

        const news = [
            { source: 'InfoMoney', title: 'Ibovespa abre em alta com otimismo no exterior' },
            { source: 'CoinDesk', title: 'Bitcoin busca estabilidade acima dos US$ 95k' },
            { source: 'Valor', title: 'D√≥lar recua com novos dados de infla√ß√£o nos EUA' },
            { source: 'Bloomberg', title: 'Mercados reagem positivamente √† ata do FED' },
            { source: 'B3', title: 'Volume de negocia√ß√£o bate recorde em janeiro' }
        ];

        // --- VARI√ÅVEIS GLOBAIS ---
        let currentDetailAsset = null;
        let myChart = null;

        // --- SISTEMA DE LOGIN ---
        function checkPassword() {
            if(document.getElementById('user-password').value === MY_PASSWORD) {
                unlockApp();
                localStorage.setItem('is_logged_in', 'true');
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }
        function unlockApp() {
            document.getElementById('lock-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            initApp();
        }
        window.onload = function() {
            if(localStorage.getItem('is_logged_in') === 'true') unlockApp();
        }

        // --- APP ---
        function initApp() {
            renderSkeleton();
            renderNews();
            fetchData();
            setInterval(fetchData, 60000);
        }

        function renderSkeleton() {
            const container = document.getElementById('cards-container');
            container.innerHTML = '';
            assets.forEach(asset => {
                container.innerHTML += createCardHTML(asset, null, true);
            });
        }

        function renderNews() {
            const newsContainer = document.getElementById('news-content');
            let html = '';
            news.forEach(n => {
                html += `<div class="ticker-item"><span class="ticker-source">${n.source}:</span> ${n.title}</div>`;
            });
            // Duplica v√°rias vezes para garantir o loop suave
            newsContainer.innerHTML = html + html + html + html; 
        }

        async function fetchData() {
            const updateLabel = document.getElementById('last-update');
            updateLabel.innerText = "Atualizando...";
            
            try {
                // 1. Moedas
                const coinsResponse = await fetch('https://economia.awesomeapi.com.br/last/USD-BRL,BTC-BRL,BTC-USD');
                const coinsData = await coinsResponse.json();

                // 2. A√ß√µes
                const tickers = assets.filter(a => a.type === 'stock' || a.type === 'index').map(a => a.id).join(',');
                const stocksResponse = await fetch(`https://brapi.dev/api/quote/${tickers},^BVSP?token=${brapiToken}`);
                const stocksJson = await stocksResponse.json();
                
                const stockMap = {};
                if(stocksJson.results) {
                    stocksJson.results.forEach(s => {
                        stockMap[s.symbol] = s;
                        stockMap[s.symbol.replace('^BVSP', 'IBOV')] = s;
                    });
                }

                const container = document.getElementById('cards-container');
                container.innerHTML = '';
                
                assets.forEach(asset => {
                    let data = null;
                    if (asset.id === 'USD') {
                        const d = coinsData.USDBRL;
                        data = { price: parseFloat(d.bid), change: parseFloat(d.pctChange), symbol: 'R$', raw: d };
                    } else if (asset.id === 'BTC') {
                        const dUsd = coinsData.BTCUSD;
                        const dBrl = coinsData.BTCBRL;
                        const valUsd = parseFloat(dUsd.bid).toLocaleString('en-US', {style:'currency', currency:'USD', minimumFractionDigits:0});
                        const valBrl = parseFloat(dBrl.bid).toLocaleString('pt-BR', {style:'currency', currency:'BRL', minimumFractionDigits:0});
                        data = { 
                            displayValue: `<span style="font-size: 0.9em">${valUsd}</span> <span class="price-secondary">/ ${valBrl}</span>`,
                            change: parseFloat(dUsd.pctChange),
                            symbol: '',
                            price: parseFloat(dUsd.bid) // para refer√™ncia
                        };
                    } else {
                        const key = asset.id === 'IBOV' ? '^BVSP' : asset.id;
                        const s = stockMap[key];
                        if (s) {
                            data = { price: s.regularMarketPrice, change: s.regularMarketChangePercent, symbol: 'R$' };
                        }
                    }
                    
                    // Cria o elemento do card
                    const cardDiv = document.createElement('div');
                    cardDiv.innerHTML = createCardHTML(asset, data);
                    // Adiciona evento de clique para abrir detalhe
                    const actualCard = cardDiv.firstElementChild; // Pega o div.card
                    if(data) {
                        actualCard.onclick = () => openDetail(asset, data);
                    }
                    container.appendChild(cardDiv);
                });

                const now = new Date();
                updateLabel.innerText = "Atualizado √†s " + now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

            } catch (error) {
                console.error(error);
                updateLabel.innerText = "Erro ao atualizar";
            }
        }

        function createCardHTML(asset, data, loading = false) {
            if (loading) return `<div class="card"><div class="card-header"><span class="ticker">${asset.id}</span></div><div class="price-container"><div class="price" style="opacity:0.3">---</div></div></div>`;
            if (!data) return `<div class="card"><div class="card-header"><span class="ticker">${asset.id}</span></div><div class="name">Indispon√≠vel</div></div>`;
            
            const isUp = data.change >= 0;
            const badgeClass = isUp ? 'up' : 'down';
            const sign = isUp ? '+' : '';
            const color = isUp ? '#34C759' : '#FF3B30';
            
            let priceHtml = data.displayValue ? data.displayValue : `${data.symbol} ${data.price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            let tickerName = asset.id === 'BTC' ? 'BTC (Global)' : asset.id;

            // Gr√°fico est√°tico SVG simples
            let path = "M 0 25 "; let y = 25;
            for(let i=1; i<=10; i++) {
                const randomMove = (Math.random() * 10) - (isUp ? 2 : 8);
                y = y + (isUp ? -Math.abs(randomMove) + 2 : Math.abs(randomMove) - 2); 
                y = Math.max(0, Math.min(30, y));
                path += `L ${i*10} ${y} `;
            }
            const sparkline = `<svg class="sparkline" viewBox="0 0 100 30" preserveAspectRatio="none"><path d="${path}" stroke="${color}" stroke-width="2" fill="none" vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

            return `
            <div class="card">
                <div class="card-header">
                    <span class="ticker">${tickerName}</span>
                    <span class="badge ${badgeClass}">${sign}${data.change.toFixed(2)}%</span>
                </div>
                <div class="price-container">
                    <div class="price">${priceHtml}</div>
                    <div class="name">${asset.name}</div>
                </div>
                ${sparkline}
            </div>`;
        }

        // --- DETALHES & GR√ÅFICOS ---
        
        function openDetail(asset, currentData) {
            currentDetailAsset = asset;
            document.getElementById('detail-view').classList.add('active');
            
            // Preenche info b√°sica
            document.getElementById('detail-ticker').innerText = asset.id;
            document.getElementById('detail-name').innerText = asset.name;
            
            // Preenche pre√ßo grande
            let displayPrice = currentData.price.toLocaleString('pt-BR', {style: 'currency', currency: asset.id === 'BTC' ? 'USD' : 'BRL'});
            if(asset.id === 'BTC') displayPrice = displayPrice.replace('US$', 'USD '); // Ajuste visual
            
            document.getElementById('detail-price').innerText = displayPrice;
            
            const isUp = currentData.change >= 0;
            const sign = isUp ? '+' : '';
            const color = isUp ? '#34C759' : '#FF3B30';
            const changeElem = document.getElementById('detail-change');
            changeElem.innerText = `${sign}${currentData.change.toFixed(2)}%`;
            changeElem.style.color = color;

            // Reseta bot√µes e carrega gr√°fico 1D
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.period-btn')[0].classList.add('active');
            loadChart('1d');
        }

        function closeDetail() {
            document.getElementById('detail-view').classList.remove('active');
        }

        function changePeriod(period) {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadChart(period);
        }

        async function loadChart(range) {
            const ctx = document.getElementById('assetChart').getContext('2d');
            const loader = document.getElementById('chart-loading');
            
            if (myChart) myChart.destroy();
            loader.style.display = 'block';

            let labels = [];
            let prices = [];
            let isStock = (currentDetailAsset.type === 'stock' || currentDetailAsset.type === 'index');

            try {
                if (isStock) {
                    // --- L√ìGICA PARA A√á√ïES (BRAPI) ---
                    // Range mapping: 1d, 5d, 1mo, 1y
                    // Interval mapping: 1d -> 15m (se poss√≠vel), 5d -> 60m, 1mo -> 1d, 1y -> 1d
                    let apiRange = range;
                    let apiInterval = '1d';
                    
                    if(range === '1d') { apiRange = '1d'; apiInterval = '15m'; } // Tenta intraday
                    if(range === '5d') { apiRange = '5d'; apiInterval = '60m'; }
                    if(range === '1mo') { apiRange = '1mo'; apiInterval = '1d'; }
                    if(range === '1y') { apiRange = '1y'; apiInterval = '1d'; }

                    const ticker = currentDetailAsset.id === 'IBOV' ? '^BVSP' : currentDetailAsset.id;
                    const url = `https://brapi.dev/api/quote/${ticker}?range=${apiRange}&interval=${apiInterval}&token=${brapiToken}`;
                    
                    const res = await fetch(url);
                    const json = await res.json();
                    
                    if(json.results && json.results[0].historicalDataPrice) {
                        const history = json.results[0].historicalDataPrice;
                        history.forEach(point => {
                            // Formata data/hora dependendo do range
                            let label = '';
                            const date = new Date(point.date * 1000);
                            if(range === '1d') label = date.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                            else if(range === '5d') label = date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) + ' ' + date.getHours() + 'h';
                            else label = date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
                            
                            labels.push(label);
                            prices.push(point.close);
                        });
                    }
                } else {
                    // --- L√ìGICA PARA MOEDAS (AWESOMEAPI) ---
                    // AwesomeAPI free n√£o tem intraday hist√≥rico f√°cil. 
                    // 1D: Mostramos apenas um ponto ou simulamos.
                    // 5D, 1M, 1Y: Usamos endpoint /daily
                    
                    let code = currentDetailAsset.id === 'USD' ? 'USD-BRL' : 'BTC-USD';
                    let days = 1;
                    if(range === '5d') days = 5;
                    if(range === '1mo') days = 30;
                    if(range === '1y') days = 360;

                    if(range === '1d') {
                        // Sem hist√≥rico intraday na free API, simula linha reta ou pega 2 pontos
                        // Aqui apenas deixamos vazio para n√£o quebrar, ou repetimos o pre√ßo atual
                        labels = ["Abertura", "Agora"];
                        prices = [prices[0], prices[0]]; // Placeholder
                    } else {
                        const res = await fetch(`https://economia.awesomeapi.com.br/json/daily/${code}/${days}`);
                        const json = await res.json();
                        // AwesomeAPI retorna do mais novo para o mais antigo, precisamos inverter
                        json.reverse().forEach(point => {
                            const date = new Date(point.timestamp * 1000);
                            labels.push(date.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}));
                            prices.push(parseFloat(point.bid));
                        });
                    }
                }

                loader.style.display = 'none';
                
                // Cor do gr√°fico
                const color = (prices[prices.length-1] >= prices[0]) ? '#34C759' : '#FF3B30';
                
                // Renderiza Chart.js
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: prices,
                            borderColor: color,
                            backgroundColor: color + '10', // 10 = transpar√™ncia hex
                            borderWidth: 2,
                            tension: 0.2, // suaviza√ß√£o
                            pointRadius: 0,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                        scales: {
                            x: { display: false }, // Oculta eixo X para visual limpo
                            y: { position: 'right', grid: { display: false } }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

            } catch (e) {
                console.error(e);
                loader.innerText = "Dados indispon√≠veis para este per√≠odo";
            }
        }
    </script>
</body>
</html>
